LATEST CODE 



DECLARE

 @BronzeCOLUMNListSTAGE100      NVARCHAR(MAX) = ''
,@BronzeColumnsForHashSTG100	NVARCHAR(MAX) = '' 
,@BronzeColumnsForHashTGT100    NVARCHAR(MAX) = ''

;

SELECT @BronzeColumnsForHashSTG100 = @BronzeColumnsForHashSTG100     + ColumnName100       + ',' + '''%''' +',' 
	  ,@BronzeCOLUMNListSTAGE100   = @BronzeCOLUMNListSTAGE100       + ColumnNameSTAGE100  + ','
	  ,@BronzeColumnsForHashTGT100 = @BronzeColumnsForHashTGT100    + '[' + ColumnName100      + ']' + REPLACE(ISNULL(CollationName,''),'SQL_Latin1_General_CP1_CI_AS','COLLATE Latin1_General_100_BIN2_UTF8') + ',' + '''%''' +','

  FROM (
        SELECT 
              Table_Schema                                      as SchemaName 
             ,Table_Name                                        as TableName
             ,Ordinal_Position                                  as ColumnId
             ,Collation_name                                  as CollationName
	         ,Data_Type
	         ,Case when Data_Type = 'smalldatetime' 
	               then 'CONVERT(smalldatetime,'+ Column_Name + ',' + '104' + ')' + ' as ' + Column_Name
			       else Column_Name
		       End as ColumnNameSTAGE100
             ,Case when Data_Type = 'smalldatetime' 
	               then 'CONVERT(smalldatetime,'+ Column_Name + ',' + '104' + ')'
			       else Column_Name
		       End as ColumnName100
	  --,Column_Name + ' as '  + 'STAGE' + Column_Name               as ColumnNameSTAGE100
	  ,Column_Name +']' + ' as '  +  '[' + 'DELTA' + Column_Name   as ColumnNameDELTA
  FROM EclipseBronze.INFORMATION_SCHEMA.COLUMNS
 WHERE Table_Schema = 'dbo' and Table_Name = 'Policy' and Ordinal_Position <= 100
   AND Column_Name NOT IN ('RowNumber','EffectiveDateUTC','EndDateUTC','Current','BronzeStagingSystemLoadID','BronzeSystemLoadID')
	   ) T1

print 'STG 100 Columns      = ' + @BronzeCOLUMNListSTAGE100   
print 'STG 100 Columns Hash = ' + @BronzeColumnsForHashSTG100
print 'TGT 100 Columns Hash = ' + @BronzeColumnsForHashTGT100

---------------------------------------------------------------

SELECT 
--100 Columns
      ProgramRef,LayerNum,StatsCcyROE,CONVERT(smalldatetime,AnnivDate,104) as AnnivDate,DaysNotice,UW,Interest,PolicyId,PolicyRef,EntryType,DecRef,LloydsBrokerId,LloydsBrokerRef,LloydsBrokerContactId,BucketInd,PeriodType,CONVERT(smalldatetime,InceptionDate,104) as InceptionDate,CONVERT(smalldatetime,ExpiryDate,104) as ExpiryDate,TermsOfTrade,CONVERT(smalldatetime,DateWritten,104) as DateWritten,CONVERT(smalldatetime,FirstWritten,104) as FirstWritten,ClaimInd,Brokerage,Deductions,CONVERT(smalldatetime,CancelDate,104) as CancelDate,StatsCcyISO,ConsCcyISO,ConsTotalSyndEPI,ConsTotalSyndExposure,Notes,RenewedFromRef,RenewedToRef,GrossPremIncome,Comm,CommMisc,CoverType,UniqueMarketRef,PlacingType,WordingStatus,PortfolioTransInd,LossOfUseDaily,CONVERT(smalldatetime,LastUpd,104) as LastUpd,SectionCode,Period,FullTermPeriod,CONVERT(smalldatetime,FullTermInceptionDate,104) as FullTermInceptionDate,CONVERT(smalldatetime,FullTermExpiryDate,104) as FullTermExpiryDate,FullTermResignInd,ProfitComm,ProfitComm2,CommDeductionsInd,ProfitCommExpense,OtherDeductions,PremFreq,CONVERT(smalldatetime,FirstSettDueDate,104) as FirstSettDueDate,SettTermOfTrade,AdjTermsOfTrade,CoverMaxPeriod,CommSlideAt,BordereauPremTermsOfTrade,TreatyReinsInd,CoIns,SysLastUpd,NoClaimBonus,EarnPattern,LossOfUseLimit,LossOfUseXs,LossOfUseExposure,LossOfUseCcyISO,LossOfUseXsDsc,CommSlide,CommSlideProv,CommSlideLR,CommSlideMin,BordereauClaimTermsOfTrade,WaitPeriod,SmokerInd,BordereauClaimFreq,Sex,CONVERT(smalldatetime,DateOfBirth,104) as DateOfBirth,QuotaSharePct,BordereauPremFreq,QuotaShareLine,ConvertedInd,IPTPct,IPTPremApplic,RepGroup,SysPolicyType,TotalSyndEPI,TotalSyndExposure,UWDivision,WriteBackPct,LloydsBrokerCode,LloydsBrokerPseud,YOA,PerilGroupId,TerritoryId,TopLimit,TopLimitCcyISO,TopXs
     ,HASHBYTES('SHA1',CONVERT(NVARCHAR(MAX),CONCAT(ProgramRef,'%',LayerNum,'%',StatsCcyROE,'%',CONVERT(smalldatetime,AnnivDate,104),'%',DaysNotice,'%',UW,'%',Interest,'%',PolicyId,'%',PolicyRef,'%',EntryType,'%',DecRef,'%',LloydsBrokerId,'%',LloydsBrokerRef,'%',LloydsBrokerContactId,'%',BucketInd,'%',PeriodType,'%',CONVERT(smalldatetime,InceptionDate,104),'%',CONVERT(smalldatetime,ExpiryDate,104),'%',TermsOfTrade,'%',CONVERT(smalldatetime,DateWritten,104),'%',CONVERT(smalldatetime,FirstWritten,104),'%',ClaimInd,'%',Brokerage,'%',Deductions,'%',CONVERT(smalldatetime,CancelDate,104),'%',StatsCcyISO,'%',ConsCcyISO,'%',ConsTotalSyndEPI,'%',ConsTotalSyndExposure,'%',Notes,'%',RenewedFromRef,'%',RenewedToRef,'%',GrossPremIncome,'%',Comm,'%',CommMisc,'%',CoverType,'%',UniqueMarketRef,'%',PlacingType,'%',WordingStatus,'%',PortfolioTransInd,'%',LossOfUseDaily,'%',CONVERT(smalldatetime,LastUpd,104),'%',SectionCode,'%',Period,'%',FullTermPeriod,'%',CONVERT(smalldatetime,FullTermInceptionDate,104),'%',CONVERT(smalldatetime,FullTermExpiryDate,104),'%',FullTermResignInd,'%',ProfitComm,'%',ProfitComm2,'%',CommDeductionsInd,'%',ProfitCommExpense,'%',OtherDeductions,'%',PremFreq,'%',CONVERT(smalldatetime,FirstSettDueDate,104),'%',SettTermOfTrade,'%',AdjTermsOfTrade,'%',CoverMaxPeriod,'%',CommSlideAt,'%',BordereauPremTermsOfTrade,'%',TreatyReinsInd,'%',CoIns,'%',SysLastUpd,'%',NoClaimBonus,'%',EarnPattern,'%',LossOfUseLimit,'%',LossOfUseXs,'%',LossOfUseExposure,'%',LossOfUseCcyISO,'%',LossOfUseXsDsc,'%',CommSlide,'%',CommSlideProv,'%',CommSlideLR,'%',CommSlideMin,'%',BordereauClaimTermsOfTrade,'%',WaitPeriod,'%',SmokerInd,'%',BordereauClaimFreq,'%',Sex,'%',CONVERT(smalldatetime,DateOfBirth,104),'%',QuotaSharePct,'%',BordereauPremFreq,'%',QuotaShareLine,'%',ConvertedInd,'%',IPTPct,'%',IPTPremApplic,'%',RepGroup,'%',SysPolicyType,'%',TotalSyndEPI,'%',TotalSyndExposure,'%',UWDivision,'%',WriteBackPct,'%',LloydsBrokerCode,'%',LloydsBrokerPseud,'%',YOA,'%',PerilGroupId,'%',TerritoryId,'%',TopLimit,'%',TopLimitCcyISO,'%',TopXs))) as HB100
  FROM OPENROWSET ( 
  BULK 'https://dldpdev01.blob.core.windows.net/bronze/underwriting/Internal/Eclipse/Staging/dbo_Policy/SystemLoadID=1022022101001/**',
  FORMAT = 'parquet'
  ) as RS
 WHERE PolicyId = 28

SELECT 
--100 Columns
      ProgramRef as DELTAProgramRef,LayerNum as DELTALayerNum,StatsCcyROE as DELTAStatsCcyROE,AnnivDate as DELTAAnnivDate,DaysNotice as DELTADaysNotice,UW as DELTAUW,Interest as DELTAInterest,PolicyId as DELTAPolicyId,PolicyRef as DELTAPolicyRef,EntryType as DELTAEntryType,DecRef as DELTADecRef,LloydsBrokerId as DELTALloydsBrokerId,LloydsBrokerRef as DELTALloydsBrokerRef,LloydsBrokerContactId as DELTALloydsBrokerContactId,BucketInd as DELTABucketInd,PeriodType as DELTAPeriodType,InceptionDate as DELTAInceptionDate,ExpiryDate as DELTAExpiryDate,TermsOfTrade as DELTATermsOfTrade,DateWritten as DELTADateWritten,FirstWritten as DELTAFirstWritten,ClaimInd as DELTAClaimInd,Brokerage as DELTABrokerage,Deductions as DELTADeductions,CancelDate as DELTACancelDate,StatsCcyISO as DELTAStatsCcyISO,ConsCcyISO as DELTAConsCcyISO,ConsTotalSyndEPI as DELTAConsTotalSyndEPI,ConsTotalSyndExposure as DELTAConsTotalSyndExposure,Notes as DELTANotes,RenewedFromRef as DELTARenewedFromRef,RenewedToRef as DELTARenewedToRef,GrossPremIncome as DELTAGrossPremIncome,Comm as DELTAComm,CommMisc as DELTACommMisc,CoverType as DELTACoverType,UniqueMarketRef as DELTAUniqueMarketRef,PlacingType as DELTAPlacingType,WordingStatus as DELTAWordingStatus,PortfolioTransInd as DELTAPortfolioTransInd,LossOfUseDaily as DELTALossOfUseDaily,LastUpd as DELTALastUpd,SectionCode as DELTASectionCode,Period as DELTAPeriod,FullTermPeriod as DELTAFullTermPeriod,FullTermInceptionDate as DELTAFullTermInceptionDate,FullTermExpiryDate as DELTAFullTermExpiryDate,FullTermResignInd as DELTAFullTermResignInd,ProfitComm as DELTAProfitComm,ProfitComm2 as DELTAProfitComm2,CommDeductionsInd as DELTACommDeductionsInd,ProfitCommExpense as DELTAProfitCommExpense,OtherDeductions as DELTAOtherDeductions,PremFreq as DELTAPremFreq,FirstSettDueDate as DELTAFirstSettDueDate,SettTermOfTrade as DELTASettTermOfTrade,AdjTermsOfTrade as DELTAAdjTermsOfTrade,CoverMaxPeriod as DELTACoverMaxPeriod,CommSlideAt as DELTACommSlideAt,BordereauPremTermsOfTrade as DELTABordereauPremTermsOfTrade,TreatyReinsInd as DELTATreatyReinsInd,CoIns as DELTACoIns,SysLastUpd as DELTASysLastUpd,NoClaimBonus as DELTANoClaimBonus,EarnPattern as DELTAEarnPattern,LossOfUseLimit as DELTALossOfUseLimit,LossOfUseXs as DELTALossOfUseXs,LossOfUseExposure as DELTALossOfUseExposure,LossOfUseCcyISO as DELTALossOfUseCcyISO,LossOfUseXsDsc as DELTALossOfUseXsDsc,CommSlide as DELTACommSlide,CommSlideProv as DELTACommSlideProv,CommSlideLR as DELTACommSlideLR,CommSlideMin as DELTACommSlideMin,BordereauClaimTermsOfTrade as DELTABordereauClaimTermsOfTrade,WaitPeriod as DELTAWaitPeriod,SmokerInd as DELTASmokerInd,BordereauClaimFreq as DELTABordereauClaimFreq,Sex as DELTASex,DateOfBirth as DELTADateOfBirth,QuotaSharePct as DELTAQuotaSharePct,BordereauPremFreq as DELTABordereauPremFreq,QuotaShareLine as DELTAQuotaShareLine,ConvertedInd as DELTAConvertedInd,IPTPct as DELTAIPTPct,IPTPremApplic as DELTAIPTPremApplic,RepGroup as DELTARepGroup,SysPolicyType as DELTASysPolicyType,TotalSyndEPI as DELTATotalSyndEPI,TotalSyndExposure as DELTATotalSyndExposure,UWDivision as DELTAUWDivision,WriteBackPct as DELTAWriteBackPct,LloydsBrokerCode as DELTALloydsBrokerCode,LloydsBrokerPseud as DELTALloydsBrokerPseud,YOA as DELTAYOA,PerilGroupId as DELTAPerilGroupId,TerritoryId as DELTATerritoryId,TopLimit as DELTATopLimit,TopLimitCcyISO as DELTATopLimitCcyISO,TopXs as DELTATopXs
     --,HASHBYTES('SHA1',CONVERT(VARCHAR(MAX),CONCAT(ProgramRef,'%',LayerNum,'%',StatsCcyROE,'%',AnnivDate,'%',DaysNotice,'%',UW,'%',Interest,'%',PolicyId,'%',PolicyRef,'%',EntryType,'%',DecRef,'%',LloydsBrokerId,'%',LloydsBrokerRef,'%',LloydsBrokerContactId,'%',BucketInd,'%',PeriodType,'%',InceptionDate,'%',ExpiryDate,'%',TermsOfTrade,'%',DateWritten,'%',FirstWritten,'%',ClaimInd,'%',Brokerage,'%',Deductions,'%',CancelDate,'%',StatsCcyISO,'%',ConsCcyISO,'%',ConsTotalSyndEPI,'%',ConsTotalSyndExposure,'%',Notes,'%',RenewedFromRef,'%',RenewedToRef,'%',GrossPremIncome,'%',Comm,'%',CommMisc,'%',CoverType,'%',UniqueMarketRef,'%',PlacingType,'%',WordingStatus,'%',PortfolioTransInd,'%',LossOfUseDaily,'%',LastUpd,'%',SectionCode,'%',Period,'%',FullTermPeriod,'%',FullTermInceptionDate,'%',FullTermExpiryDate,'%',FullTermResignInd,'%',ProfitComm,'%',ProfitComm2,'%',CommDeductionsInd,'%',ProfitCommExpense,'%',OtherDeductions,'%',PremFreq,'%',FirstSettDueDate,'%',SettTermOfTrade,'%',AdjTermsOfTrade,'%',CoverMaxPeriod,'%',CommSlideAt,'%',BordereauPremTermsOfTrade,'%',TreatyReinsInd,'%',CoIns,'%',SysLastUpd,'%',NoClaimBonus,'%',EarnPattern,'%',LossOfUseLimit,'%',LossOfUseXs,'%',LossOfUseExposure,'%',LossOfUseCcyISO,'%',LossOfUseXsDsc,'%',CommSlide,'%',CommSlideProv,'%',CommSlideLR,'%',CommSlideMin,'%',BordereauClaimTermsOfTrade,'%',WaitPeriod,'%',SmokerInd,'%',BordereauClaimFreq,'%',Sex,'%',DateOfBirth,'%',QuotaSharePct,'%',BordereauPremFreq,'%',QuotaShareLine,'%',ConvertedInd,'%',IPTPct,'%',IPTPremApplic,'%',RepGroup,'%',SysPolicyType,'%',TotalSyndEPI,'%',TotalSyndExposure,'%',UWDivision,'%',WriteBackPct,'%',LloydsBrokerCode,'%',LloydsBrokerPseud,'%',YOA,'%',PerilGroupId,'%',TerritoryId,'%',TopLimit,'%',TopLimitCcyISO,'%',TopXs,'%'))) as HB100
     ,HASHBYTES('SHA1',CONVERT(NVARCHAR(MAX),CONCAT([ProgramRef]COLLATE Latin1_General_100_BIN2_UTF8,'%',[LayerNum],'%',[StatsCcyROE],'%',[AnnivDate],'%',[DaysNotice],'%',[UW]COLLATE Latin1_General_100_BIN2_UTF8,'%',[Interest]COLLATE Latin1_General_100_BIN2_UTF8,'%',[PolicyId],'%',[PolicyRef]COLLATE Latin1_General_100_BIN2_UTF8,'%',[EntryType]COLLATE Latin1_General_100_BIN2_UTF8,'%',[DecRef]COLLATE Latin1_General_100_BIN2_UTF8,'%',[LloydsBrokerId],'%',[LloydsBrokerRef]COLLATE Latin1_General_100_BIN2_UTF8,'%',[LloydsBrokerContactId],'%',[BucketInd]COLLATE Latin1_General_100_BIN2_UTF8,'%',[PeriodType]COLLATE Latin1_General_100_BIN2_UTF8,'%',[InceptionDate],'%',[ExpiryDate],'%',[TermsOfTrade],'%',[DateWritten],'%',[FirstWritten],'%',[ClaimInd]COLLATE Latin1_General_100_BIN2_UTF8,'%',[Brokerage],'%',[Deductions],'%',[CancelDate],'%',[StatsCcyISO]COLLATE Latin1_General_100_BIN2_UTF8,'%',[ConsCcyISO]COLLATE Latin1_General_100_BIN2_UTF8,'%',[ConsTotalSyndEPI],'%',[ConsTotalSyndExposure],'%',[Notes]COLLATE Latin1_General_100_BIN2_UTF8,'%',[RenewedFromRef]COLLATE Latin1_General_100_BIN2_UTF8,'%',[RenewedToRef]COLLATE Latin1_General_100_BIN2_UTF8,'%',[GrossPremIncome],'%',[Comm],'%',[CommMisc],'%',[CoverType]COLLATE Latin1_General_100_BIN2_UTF8,'%',[UniqueMarketRef]COLLATE Latin1_General_100_BIN2_UTF8,'%',[PlacingType]COLLATE Latin1_General_100_BIN2_UTF8,'%',[WordingStatus]COLLATE Latin1_General_100_BIN2_UTF8,'%',[PortfolioTransInd],'%',[LossOfUseDaily],'%',[LastUpd],'%',[SectionCode]COLLATE Latin1_General_100_BIN2_UTF8,'%',[Period]COLLATE Latin1_General_100_BIN2_UTF8,'%',[FullTermPeriod]COLLATE Latin1_General_100_BIN2_UTF8,'%',[FullTermInceptionDate],'%',[FullTermExpiryDate],'%',[FullTermResignInd],'%',[ProfitComm],'%',[ProfitComm2],'%',[CommDeductionsInd],'%',[ProfitCommExpense],'%',[OtherDeductions],'%',[PremFreq],'%',[FirstSettDueDate],'%',[SettTermOfTrade],'%',[AdjTermsOfTrade],'%',[CoverMaxPeriod]COLLATE Latin1_General_100_BIN2_UTF8,'%',[CommSlideAt],'%',[BordereauPremTermsOfTrade],'%',[TreatyReinsInd],'%',[CoIns],'%',[SysLastUpd],'%',[NoClaimBonus],'%',[EarnPattern]COLLATE Latin1_General_100_BIN2_UTF8,'%',[LossOfUseLimit],'%',[LossOfUseXs],'%',[LossOfUseExposure],'%',[LossOfUseCcyISO]COLLATE Latin1_General_100_BIN2_UTF8,'%',[LossOfUseXsDsc]COLLATE Latin1_General_100_BIN2_UTF8,'%',[CommSlide],'%',[CommSlideProv],'%',[CommSlideLR],'%',[CommSlideMin],'%',[BordereauClaimTermsOfTrade],'%',[WaitPeriod]COLLATE Latin1_General_100_BIN2_UTF8,'%',[SmokerInd],'%',[BordereauClaimFreq],'%',[Sex]COLLATE Latin1_General_100_BIN2_UTF8,'%',[DateOfBirth],'%',[QuotaSharePct],'%',[BordereauPremFreq],'%',[QuotaShareLine],'%',[ConvertedInd],'%',[IPTPct],'%',[IPTPremApplic],'%',[RepGroup]COLLATE Latin1_General_100_BIN2_UTF8,'%',[SysPolicyType]COLLATE Latin1_General_100_BIN2_UTF8,'%',[TotalSyndEPI],'%',[TotalSyndExposure],'%',[UWDivision]COLLATE Latin1_General_100_BIN2_UTF8,'%',[WriteBackPct],'%',[LloydsBrokerCode]COLLATE Latin1_General_100_BIN2_UTF8,'%',[LloydsBrokerPseud]COLLATE Latin1_General_100_BIN2_UTF8,'%',[YOA],'%',[PerilGroupId],'%',[TerritoryId],'%',[TopLimit],'%',[TopLimitCcyISO]COLLATE Latin1_General_100_BIN2_UTF8,'%',[TopXs])))TGT100

     FROM [EclipseBronze].[dbo].[Policy]
WHERE PolicyId = 28